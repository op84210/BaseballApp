@model IEnumerable<BaseballApp.Models.MonthlyBattingStats>

@{
    ViewData["Title"] = $"{ViewBag.PlayerName} - 月度打擊成績";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Url.Action("Stats", "Baseball")">打擊成績</a></li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("PlayerStats", new { playerName = ViewBag.PlayerName, season = ViewBag.Season })">
                            @ViewBag.PlayerName
                        </a>
                    </li>
                    <li class="breadcrumb-item active">月度數據</li>
                </ol>
            </nav>

            <h2>@ViewBag.PlayerName 月度打擊成績</h2>
            <p class="text-muted">@ViewBag.Season 賽季</p>
        </div>
    </div>

    <!-- 錯誤訊息 -->
    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @ViewBag.ErrorMessage
        </div>
    }

    @if (Model.Any())
    {
        <!-- 月度數據表格 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">月度表現統計</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>月份</th>
                                <th>狀態</th>
                                <th>打席</th>
                                <th>打數</th>
                                <th>安打</th>
                                <th>打擊率</th>
                                <th>全壘打</th>
                                <th>打點</th>
                                <th>得分</th>
                                <th>四壞</th>
                                <th>三振</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var stat in Model.OrderBy(s => s.Month))
                            {
                                <tr class="@(stat.IsInjured ? "table-secondary" : "")">
                                    <td><strong>@stat.Month 月</strong></td>
                                    <td>
                                        @if (stat.IsInjured)
                                        {
                                            <span class="badge bg-danger">
                                                <i class="fas fa-user-injured"></i> 受傷
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-play"></i> 正常
                                            </span>
                                        }
                                    </td>
                                    <td>@(stat.IsInjured ? "-" : stat.PlateAppearances.ToString())</td>
                                    <td>@(stat.IsInjured ? "-" : stat.AtBats.ToString())</td>
                                    <td>@(stat.IsInjured ? "-" : stat.Hits.ToString())</td>
                                    <td>@(stat.IsInjured ? "-" : stat.BattingAverage.ToString("F3"))</td>
                                    <td>@(stat.IsInjured ? "-" : stat.HomeRuns.ToString())</td>
                                    <td>@(stat.IsInjured ? "-" : stat.RBIs.ToString())</td>
                                    <td>@(stat.IsInjured ? "-" : stat.Runs.ToString())</td>
                                    <td>@(stat.IsInjured ? "-" : stat.Walks.ToString())</td>
                                    <td>@(stat.IsInjured ? "-" : stat.Strikeouts.ToString())</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 月度趨勢圖表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">月度表現趨勢</h5>
            </div>
            <div class="card-body">
                <div id="monthlyChart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body text-center">
                <h5 class="text-muted">沒有找到月度數據</h5>
                <p class="text-muted">該球員可能沒有月度統計數據</p>
            </div>
        </div>
    }

    <!-- 操作按鈕 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex gap-2">
                <a href="@Url.Action("PlayerStats", new { playerName = ViewBag.PlayerName, season = ViewBag.Season })"
                   class="btn btn-primary">
                    <i class="fas fa-user"></i> 球員總覽
                </a>
                <a href="@Url.Action("Stats", "Baseball")" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回列表
                </a>
            </div>
        </div>
    </div>
</div>

@if (Model.Any())
{
    <script src="~/lib/echarts/echarts.min.js"></script>
    <script>
        // 月度趨勢圖表
        var monthlyChart = echarts.init(document.getElementById('monthlyChart'));

        // 準備數據
        var months = @Html.Raw(Json.Serialize(Model.OrderBy(s => s.Month).Select(s => $"{s.Month}月").ToArray()));
        var battingAverages = @Html.Raw(Json.Serialize(Model.OrderBy(s => s.Month).Select(s => s.IsInjured ? (double?)null : s.BattingAverage).ToArray()));
        var homeRuns = @Html.Raw(Json.Serialize(Model.OrderBy(s => s.Month).Select(s => s.IsInjured ? (int?)null : s.HomeRuns).ToArray()));
        var rbis = @Html.Raw(Json.Serialize(Model.OrderBy(s => s.Month).Select(s => s.IsInjured ? (int?)null : s.RBIs).ToArray()));

        var monthlyOption = {
            title: {
                text: '@ViewBag.PlayerName 月度表現趨勢',
                subtext: '⚪ 正常數據 | -- -- 受傷月份'
            },
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    var result = params[0].name + '<br/>';
                    params.forEach(function(item) {
                        var value = item.value === null ? '受傷缺賽' : item.value;
                        result += item.marker + item.seriesName + ': ' + value + '<br/>';
                    });
                    return result;
                }
            },
            legend: {
                data: ['打擊率', '全壘打', '打點'],
                bottom: 10
            },
            xAxis: {
                type: 'category',
                data: months
            },
            yAxis: [
                {
                    type: 'value',
                    name: '打擊率',
                    position: 'left',
                    min: 0,
                    max: 0.4
                },
                {
                    type: 'value',
                    name: '數量',
                    position: 'right'
                }
            ],
            series: [
                {
                    name: '打擊率',
                    type: 'line',
                    yAxisIndex: 0,
                    data: battingAverages,
                    smooth: true,
                    connectNulls: false,
                    itemStyle: { color: '#5470c6' },
                    emphasis: { focus: 'series' }
                },
                {
                    name: '全壘打',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: homeRuns,
                    itemStyle: { color: '#91cc75' }
                },
                {
                    name: '打點',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: rbis,
                    itemStyle: { color: '#fac858' }
                }
            ]
        };

        monthlyChart.setOption(monthlyOption);

        // 響應式調整
        window.addEventListener('resize', function() {
            monthlyChart.resize();
        });
    </script>
}